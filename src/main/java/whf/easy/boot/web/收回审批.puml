@startuml
'https://plantuml.com/sequence-diagram

autonumber
actor 审批人
participant 审批人 order 10
participant 云费控 order 20
participant 发票中台 order 40
participant 账户中心 order 50
审批人 -> 云费控:撤回提交审批

云费控 -> 云费控:校验
note over 云费控
  <color #Red>单据不存在、单据已被处理、包含不同企业的单据</color>
end note
云费控 -[#Red]->x 审批人:单据已被处理，不能撤回
group 单据状态 [审批中]
 云费控 -> 云费控: 修改单据审批人
 云费控 --> 云费控:如果是微信分享，修改状态为已撤回
 云费控 -> 云费控:新增单据操作日志
云费控 -> 云费控:保存单据审批历史
云费控 -> 云费控:修改本地发票为未报销
else 审批结束
 云费控 -> 云费控: 修改单据审批人，单据状态改为报销中
 云费控 --> 云费控:如果是微信分享，修改状态为已撤回
 云费控 -> 云费控:新增单据操作日志
云费控 -> 云费控:保存单据审批历史
云费控 -> 云费控:修改本地发票为未报销
else 已完成
group 是否包含发票 [包含发票]
 云费控 -> 发票中台: 同步发票为报销中状态
 发票中台 -> 发票中台: 扣除发票报销额度
 发票中台 --> 云费控:success
 云费控 -> 云费控:新增单据操作日志
云费控 -> 云费控:保存单据审批历史
云费控 -> 云费控:更新单据状态为<color #Red>审批中</color>
云费控 -> 云费控:修改本地发票为已报销
云费控 -> 云费控:发送微信公众号消息给提单人
note OVER 云费控
 <color #Red>异步调用修改</color>
end note
云费控 -> 云费控:修改本地发票快照为已报销
 else 不包含发票
云费控 -> 云费控:新增单据操作日志
云费控 -> 云费控:保存单据审批历史
云费控 -> 云费控:更新单据状态为<color #Red>审批中</color>
云费控 -> 云费控:发送微信公众号消息给提单人
 end
end
云费控 -> 云费控:借款核销重新计算，明细已完成改为进行中
云费控 --> 审批人: 审批收回成功



@endumlA